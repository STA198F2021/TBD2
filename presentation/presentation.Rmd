---
title: "Relationship between COVID-19 Restrictions and Influenza"
subtitle: "In the United States"
author: "Phila's Filas (TBD2) <br> Harris Upchurch, Biniam Garomsa, Philemon Hailemariam"
institute: "Duke University"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: solarized-light
      highlightLines: true
      countIncrementalSlides: false
---

```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
# Remove any packages from this list that you're not using
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
library(dplyr)
library(broom)
library(modelr)
library(purrr)
```

```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(
  fig.retina = 3, 
  dpi = 300, 
  fig.width = 6, 
  fig.asp = 0.618, 
  out.width = "70%"
  )
```

```{r load-data, include=FALSE}
#data/libraries
ilinet <-read.csv("~/R/TBD2/data/ILINet.csv", header=TRUE)
flu<-readr::read_csv(file = '~/R/TBD2/data/State_Custom_Data.csv')
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
style_solarized_light(
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono")
)
```

class: inverse, middle, center

# Initial Questions

---

## COVID-19 and Influenza

- In an effort to combat COVID-19, many public health measures have been taken since 2020 which have the capacity to affect other diseases.

- Have these measures (especially masks and lockdowns) impacted the spread of other diseases? To what extent and which diseases?

--

- To answer this question, we focused on influenza.
--
.pull-left[
```{r flu img, echo = FALSE, out.width = "60%", fig.align = "center", fig.cap = "Image credit: CDC."}
include_graphics("img/cdc influenza.png")
```
]
.pull-center[
- Influenza is a group of related viruses. Although COVID-19 and influenza viruses have many differences, they are both respiratory illnesses which spread similarly. 
- Additionally, influenza is one of the most common and deadly infectious diseases in the United States and has its own CDC monitoring tool.
]


---

## Investigation

- First, we pulled available data for flu hospitalizations and deaths from the CDC's FluView monitoring program.

--

- We then plotted these data over the years to prepare the data to test for significance.
```{r table, echo = FALSE, warning = FALSE}
#data merging
flu2<-flu%>%
  mutate(Year = ifelse(WEEK>=40 & WEEK<=53, substr(SEASON,3,4),substr(SEASON,6,7)))%>%
  mutate(Year = paste("20",Year,sep=""))
flu2$WEEK<- as.numeric(flu2$WEEK)
flu2$Year<- as.numeric(flu2$Year)
ilinet$YEAR<-as.numeric(ilinet$YEAR)
ilinet$WEEK<- as.numeric(ilinet$WEEK)
flu_ili <- left_join(flu2,ilinet,by=c("SUB AREA" ="REGION","WEEK","Year"="YEAR"))
flu_ili<-flu_ili%>% rename("YEAR" = "Year","STATE" ="SUB AREA")
aggflu_ili <- flu_ili %>%
  mutate(year = as.character(YEAR), week = as.character(WEEK), total_flu = as.numeric(ILITOTAL)) %>%
  mutate(yearweek = ifelse(WEEK <= 9,paste(year, week, sep = '0'),paste(year, week, sep = ''))) %>%
  drop_na()%>%
  group_by(yearweek)%>%
  summarize(total_flu_patients = sum(total_flu),total_flu_deaths = sum(`NUM INFLUENZA DEATHS`))%>%
  transform(yearweek = as.numeric(yearweek))%>%
  mutate(covidstatus = ifelse(yearweek>=202009,1,0))%>%
  transform(yearweek = rank(yearweek, ties.method = 'min'))#table
flu_table<-aggflu_ili %>%
  mutate(season = ifelse(yearweek >=1 & yearweek <= 52, '2013-2014', 
                  ifelse(yearweek >=53 & yearweek <= 105, '2014-2015',
                  ifelse(yearweek >=106 & yearweek <= 157, '2015-2016',
                  ifelse(yearweek >=158 & yearweek <= 209, '2016-2017',
                  ifelse(yearweek >=210 & yearweek <= 261, '2017-2018',
                  ifelse(yearweek >=262 & yearweek <= 313, '2018-2019',
                  ifelse(yearweek >=314 & yearweek <= 365, '2019-2020',
                  ifelse(yearweek >=366 & yearweek <= 418, '2020-2021','2021-2022'
  )))))))))
```
.pull-left[
```{r seasons compare, echo = FALSE, warning = FALSE, out.width = '110%'}
#line graph
flu_table%>%
  ggplot( aes(x = yearweek, fill = season, alpha =as.character(covidstatus))) +
  geom_area(aes(y = total_flu_patients)) +
  scale_alpha_discrete(range = c(0.5, 1.0)) +
  labs(title = 'U.S. Influenza Patients',
       subtitle = 'CDC FLuView, 2013-2021',
       x = 'Weeks since beginning of 2013',
       y = 'Patients with influenza-like symptoms',
       fill = 'Season',
       alpha = 'Covid Pandemic Status') +
  theme_minimal()
```
]
.pull-right[
```{r deaths linegraph, echo = FALSE, warning = FALSE, out.width = '110%'}
flu_table%>%
  ggplot( aes(x = yearweek, fill = season, alpha =as.character(covidstatus))) +
  geom_area(aes(y = total_flu_deaths)) +
  scale_alpha_discrete(range = c(0.5, 1.0)) +
  labs(title = 'U.S. Influenza Deaths',
       subtitle = 'CDC FLuView, 2013-2021',
       x = 'Weeks since beginning of 2013',
       y = 'Influenza deaths',
       fill = 'Season',
       alpha = 'Covid Pandemic Status') +
      theme_minimal()
```
]

---


```{r linegraph 2, echo = FALSE, warning = FALSE}
covid_flu_table <- flu_table %>%
  mutate(covidstatus = ifelse(season == '2020-2021' | season == '2021-2022', 1, 0))%>%
  filter(season !='2021-2022')%>%
  group_by(season)%>%
  mutate(seasonweek = (rank(yearweek)))%>%
  ungroup()%>%
  group_by(seasonweek)
```

#Preparing for Modelling

```{r deaths linegraph 2, echo = FALSE, warning = FALSE}
covid_flu_table %>%
  ggplot( aes(x = seasonweek, color = season)) +
  geom_line(aes(y = total_flu_deaths, group = season)) +
  labs(title = 'Seasonal Influenza Deaths',
       subtitle = 'CDC, 2013-2021',
       x = 'Deaths',
       y = 'Week of Season',
       color = 'Season')
```

---

#Model

```{r model}
covid_flu_table<-covid_flu_table%>%
  group_by(season)%>%
  slice_max(order_by = total_flu_deaths, n = 10)%>%
  ungroup()
lm(total_flu_deaths ~ covidstatus, data = covid_flu_table)%>%
tidy(conf.int = TRUE)
lm(total_flu_patients ~ covidstatus, data = covid_flu_table)%>%
tidy(conf.int = TRUE)
```

---

## Plots

```{r recode-species, echo = FALSE}
# In this chunk I'm doing a bunch of analysis that I don't want to present 
# in my slides. But I need the resulting data frame for a plot I want to present.
penguins_modified <- penguins %>%
  mutate(species = fct_other(species, keep = "Adelie"))
```

```{r plot-penguins, echo = FALSE, warning = FALSE, fig.alt = "Body mass vs. flipper lenght of Palmer Penguins for species Adelie and all the others combined together. There is a relatively strong, positive relationship between the two variables. The Adelie penguins are clustered together but they don't exhibit a different trend than the rest of the penguins."}
# Code hidden with echo = FALSE
# Uses modified penguins dataset from previous chunk
# Play around with height and width until you're happy with the look
ggplot(penguins_modified, aes(x = flipper_length_mm, y = body_mass_g, color = species)) +
  geom_point() + 
  theme_minimal()
```

---

## Plot and text

.pull-left[
- Some text
- goes here
]
.pull-right[
```{r warning=FALSE, out.width="100%", fig.width=4, echo=FALSE}
# see how I changed out.width and fig.width from defaults
# to make the figure bigger
ggplot(penguins, aes(x = bill_length_mm, y = species, color = species)) +
  geom_boxplot() +
  theme_minimal()
```
]

---

class: inverse, middle, center

# A new section...

---

## Tables

If you want to generate a table, make sure it is in the HTML format (instead of Markdown or other formats), e.g.,

```{r penguins-table, echo = FALSE}
kable(head(penguins), format = "html")
```

---

## Images

```{r castle, echo = FALSE, out.width = "40%", fig.align = "center", fig.cap = "Image credit: Danielle Navarro, Percolate."}
include_graphics("img/watercolour_sys02_img32_percolate.jpg")
```

Or you can also include a full page image. See next slide.

---

background-image: url(img/watercolour_sys02_img32_percolate.jpg)

---

## Math Expressions

You can write LaTeX math expressions inside a pair of dollar signs, e.g. &#36;\alpha+\beta$ renders $\alpha+\beta$. You can use the display style with double dollar signs:

```
$$\bar{X}=\frac{1}{n}\sum_{i=1}^nX_i$$
```

$$\bar{X}=\frac{1}{n}\sum_{i=1}^nX_i$$

Limitations:

1. The source code of a LaTeX math expression must be in one line, unless it is inside a pair of double dollar signs, in which case the starting `$$` must appear in the very beginning of a line, followed immediately by a non-space character, and the ending `$$` must be at the end of a line, led by a non-space character;

1. There should not be spaces after the opening `$` or before the closing `$`.

1. Math does not work on the title slide (see [#61](https://github.com/yihui/xaringan/issues/61) for a workaround).

---

class: inverse, middle, center

# Wrap up

---

## Feeling adventurous?

- Want to find out more about `xaringan`? See https://slides.yihui.name/xaringan/#1.

- You are welcomed to use the default styling of the slides. In fact, that's what I expect the majority of you will do. You will differentiate yourself with the content of your presentation.

- But some of you might want to play around with slide styling. The 
`xaringanthemer` provides some solutions for this that: https://pkg.garrickadenbuie.com/xaringanthemer.

- And if you want more bells and whistles, there is also `xaringanExtra`: https://pkg.garrickadenbuie.com/xaringanExtra.
